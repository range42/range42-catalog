#
# ISSUE 38 
#

# FROM debian:stretch

FROM debian/eol:stretch
RUN apt-get update 
RUN apt-get install -y --no-install-recommends build-essential wget ca-certificates zlib1g-dev libssl1.0-dev libpam0g-dev 
RUN rm -rf /var/lib/apt/lists/*

#
# INSTALL SSH 
#

# WORKDIR /tmp
# RUN wget https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-7.7p1.tar.gz 
# RUN tar xzf openssh-7.7p1.tar.gz 
# WORKDIR ./openssh-7.7p1 

# RUN ./configure --prefix=/usr --sysconfdir=/etc/ssh 
# RUN make -j"$(nproc)"
# RUN make install 

WORKDIR /tmp
RUN wget https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-7.7p1.tar.gz \
    tar xzf openssh-7.7p1.tar.gz 

WORKDIR ./openssh-7.7p1 

RUN ./configure --prefix=/usr --sysconfdir=/etc/ssh  \
    make -j"$(nproc)" \ 
    make install 

#
# CREATE SSHD u/g for priv separations.
# 
RUN getent group sshd >/dev/null || groupadd -r sshd 
RUN id -u sshd >/dev/null 2>&1 || useradd -r -g sshd -d / -s /usr/sbin/nologin -c "sshd priv separation user" sshd

#
# 
#

RUN mkdir -p /var/run/sshd
RUN /tmp/openssh-7.7p1/ssh-keygen -A

#
# CONFIG TESTS
#
RUN /usr/sbin/sshd -t && /usr/sbin/sshd -T | head -n5

#
# CREATE USERS
#
RUN useradd -m -s /bin/bash this && \
    echo "this:this" | chpasswd && \
    usermod -aG sudo this

RUN useradd -m -s /bin/bash server && \
    echo "server:server" | chpasswd && \
    usermod -aG sudo server
RUN useradd -m -s /bin/bash is && \
    echo "is:is" | chpasswd && \
    usermod -aG sudo is
RUN useradd -m -s /bin/bash vulnerable && \
    echo "vulnerable:vulnerable" | chpasswd && \
    usermod -aG sudo vulnerable

RUN useradd -m test && echo "test:test" | chpasswd && mkdir -p /var/run/sshd

EXPOSE 22
# CMD ["/usr/sbin/sshd -D && sleep infinity; "]
CMD ["/usr/sbin/sshd","-D","-e"]