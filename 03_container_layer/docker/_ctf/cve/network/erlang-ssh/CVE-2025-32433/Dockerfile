#
# ISSUE 42 
#



# # ---------- STAGE 1: BUILDER ----------
# FROM erlang:27.3.2-slim AS builder
# WORKDIR /build

# # Si ton escript est déjà prêt
# COPY start_ssh.escript .
# RUN chmod +x start_ssh.escript

# # (Option rebar3 si un jour tu buildes un escript depuis un projet)
# # COPY . .
# # RUN apt-get update && apt-get install -y --no-install-recommends curl \
# #   && curl -fsSL https://get.rebar3.org | sh -s -- -f \
# #   && ./rebar3 escriptize \
# #   && mv _build/default/bin/start_ssh start_ssh.escript


# # ---------- STAGE 2: RUNNER ----------
# FROM erlang:27.3.2-slim AS runner
# WORKDIR /usr/local/bin

# # Client SSH uniquement (léger)
# RUN set -eux; \
#     apt-get update; \
#     apt-get install -y --no-install-recommends openssh-client; \
#     rm -rf /var/lib/apt/lists/*; \
#     mkdir -p /etc/ssh

# # Escript + entrypoint
# COPY --from=builder /build/start_ssh.escript /usr/local/bin/start_ssh.escript
# COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
# RUN chmod +x /usr/local/bin/start_ssh.escript /usr/local/bin/docker-entrypoint.sh

# ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
# CMD []



#
# BUILDER 
#

FROM debian:bookworm AS BUILDER
WORKDIR /build


RUN apt-get update && apt-get install -y \
    git build-essential libssl-dev autoconf libncurses5-dev \
    libgl1-mesa-dev libglu1-mesa-dev libpng-dev \
    libssh-dev libxml2-utils xsltproc fop wget curl \
    openssh-client && \
    rm -rf /var/lib/apt/lists/*

#
# COMPILE VULN ERLANG
#

RUN git clone https://github.com/erlang/otp.git && \
    cd otp && \
    git checkout OTP-26.2.5.10 && \
    ./configure --prefix=/usr && \
    make -j"$(nproc)" && \
    make install

#
# ADD SSH MODULE 
#
WORKDIR /src
COPY ssh_server.erl .
RUN erlc ssh_server.erl

#
# RUNNER
#

FROM debian:bookworm-slim AS RUNNER
WORKDIR /app


RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-client libssl3 libncurses6 libgl1 libglu1-mesa libpng16-16 libssh-4 && \
    rm -rf /var/lib/apt/lists/*

#
# COPY BUILDED FILES 
#
COPY --from=BUILDER /usr /usr
COPY --from=BUILDER /src/ssh_server.beam /app/

#
# GEN KEY AT STARTUP 
#
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 2222
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD []
