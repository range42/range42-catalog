#
# ISSUE 50 
#

FROM debian:buster-20221219

# THIS WILL NOT WORK.
#
# RUN echo "deb http://archive.debian.org/debian buster main contrib non-free" > /etc/apt/sources.list && \
#     echo "deb http://archive.debian.org/debian-security buster/updates main contrib non-free" >> /etc/apt/sources.list && \
#     echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid && \
#     apt-get update 

#
# BACK TO THE PASTE MARTY.
#
RUN printf 'deb [check-valid-until=no] http://snapshot.debian.org/archive/debian/20211010T000000Z buster main\n' > /etc/apt/sources.list && \
    printf 'deb [check-valid-until=no] http://snapshot.debian.org/archive/debian-security/20211010T000000Z buster/updates main\n' >> /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid && \
    apt-get update
#
# SETUP NGINX and OPENSSL 
#
RUN apt-get install -y --allow-unauthenticated --no-install-recommends \
    openssl=1.1.1d-0+deb10u7 \
    libssl1.1=1.1.1d-0+deb10u7 

# RUN apt-get install -y --allow-unauthenticated nginx openssl libssl1.1
RUN rm -rf /var/lib/apt/lists/*

#
# GEN SSL CERT
#
RUN mkdir -p /etc/nginx/ssl && \
    openssl req -x509 -newkey rsa:2048 \
    -keyout /etc/nginx/ssl/key.pem -out /etc/nginx/ssl/cert.pem \
    -days 365 -nodes -subj "/C=LU/ST=LAB/L=LAB/O=LAB/CN=localhost"

#
# NGINX CONFIGURATION
#
RUN rm /etc/nginx/sites-enabled/default && \
    echo "server { \
    listen 443 ssl; \
    ssl_certificate /etc/nginx/ssl/cert.pem; \
    ssl_certificate_key /etc/nginx/ssl/key.pem; \
    location / { return 200 'LAB OK\\n'; } \
    }" > /etc/nginx/sites-enabled/ssl.conf

EXPOSE 443
#CMD ["nginx", "-g", "daemon off;"]
CMD ["/bin/bash"]