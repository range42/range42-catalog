#
# ISSUE - 74
#

#
# BUILDER
#

FROM php:7.2.10-fpm AS builder
WORKDIR /app

#
# COPY WEB APP AND CONFIG
#

COPY web_app/ ./web_app/
COPY config/nginx/ ./config/nginx/

# CHOWN APP

RUN chown -R www-data:www-data /app/web_app

#
# RUNNER
#

FROM php:7.2.10-fpm AS runner
WORKDIR /var/www/html

#
# BACK TO THE PAST MARTY 
#

RUN set -eux; \
    rm -f /etc/apt/sources.list.d/*.list; \
    : > /etc/apt/sources.list; \
    printf 'deb [trusted=yes] http://snapshot.debian.org/archive/debian/20181001T000000Z stretch main contrib non-free\n' >> /etc/apt/sources.list; \
    printf 'deb [trusted=yes] http://snapshot.debian.org/archive/debian-security/20181001T000000Z stretch/updates main contrib non-free\n' >> /etc/apt/sources.list; \
    printf 'Acquire::Check-Valid-Until "false";\nAcquire::Check-Date "false";\nAcquire::AllowInsecureRepositories "true";\n' \
    > /etc/apt/apt.conf.d/99-snapshot-eol; \
    rm -rf /var/lib/apt/lists/*; \
    apt-get -o Acquire::AllowInsecureRepositories=true update

#
# INSTALL NGINX 
#

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends nginx; \
    ln -s /var/www/html /usr/share/nginx/html

#
# REMOVE DEFAULT WEBSITE SITE 
#
# RUN set -eux; \
#   rm -f /etc/nginx/sites-enabled/default /etc/nginx/conf.d/default.conf; \
#   mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled
# COPY config/nginx/default.conf /etc/nginx/sites-available/app.conf
# RUN ln -s /etc/nginx/sites-available/app.conf /etc/nginx/sites-enabled/app.conf


# DEPLOY APP FROM BUILDER 

COPY --from=builder /app/web_app/ /var/www/html/
COPY --from=builder /app/config/nginx/ /etc/nginx/conf.d/
COPY --from=builder /app/config/nginx/start.sh /usr/local/bin/start.sh

RUN chmod +x /usr/local/bin/start.sh
RUN chown -R www-data:www-data /var/www/html || true

EXPOSE 80
CMD ["/usr/local/bin/start.sh"]



