#
# ISSUE 41 
#

#
# STAGE 01 - BUILDER 
#


FROM node:20-alpine AS BUILDER
WORKDIR /app


RUN corepack enable && corepack prepare yarn@1.22.22 --activate
COPY package.json ./package.json
#
# COPY the vulnerable  vite.config.js 
#
COPY vite.config.js ./vite.config.js
COPY src/ src/
COPY index.html index.html

RUN yarn install --frozen-lockfile
RUN yarn build


#
# STAGE 02 - RUNNER 
#

FROM node:20-alpine AS RUNNER
WORKDIR /srv/app

RUN corepack enable && corepack prepare yarn@1.22.22 --activate
RUN npm i -g vite@6.2.2
COPY --from=BUILDER /app/ ./

ENV NODE_ENV=development
EXPOSE 80

#
# vuln will not exploitable in preview mode ! :) 
#
# CMD ["vite","preview","--host","0.0.0.0","--port","80","--strictPort","--outDir","./dist"]


# fix 
CMD ["npx","vite","dev","--host","0.0.0.0","--port","80","--strictPort"]
