#
# ISSUE 39 
#


#
# STAGE 01 - BUILDER 
#

FROM debian:bookworm-slim AS BUILDER

ARG PDFJS_VERSION=4.1.392
ARG PDFJS_ZIP=pdfjs-${PDFJS_VERSION}-dist.zip
ARG PDFJS_URL=https://github.com/mozilla/pdf.js/releases/download/v${PDFJS_VERSION}/${PDFJS_ZIP}

RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends ca-certificates curl unzip; \
    curl -fsSLo /tmp/${PDFJS_ZIP} "${PDFJS_URL}"; \
    mkdir -p /opt/pdfjs; \
    unzip -q /tmp/${PDFJS_ZIP} -d /opt/pdfjs; \
    rm -f /tmp/${PDFJS_ZIP}; \
    apt-get purge -y --auto-remove curl unzip; \
    rm -rf /var/lib/apt/lists/*

#
# STAGE 02 - RUNNER 
#

# FROM debian:bookworm-slim

# #
# # INSTALL APACHE 
# #
# RUN set -eux; \
#     apt-get update; \
#     apt-get install -y --no-install-recommends apache2; \
#     rm -rf /var/lib/apt/lists/*


FROM php:8.2-apache

RUN { \
    echo "file_uploads=On"; \
    echo "upload_max_filesize=25M"; \
    echo "post_max_size=25M"; \
    echo "max_file_uploads=1"; \
    } > /usr/local/etc/php/conf.d/uploads.ini

#
# INSTALL PDFJS IN WEBROOT 
#

COPY --from=BUILDER /opt/pdfjs/ /var/www/html/

COPY index.php /var/www/html/index.php

RUN set -eux; \
    mkdir -p /var/www/html/upload; \
    chown -R www-data:www-data /var/www/html

EXPOSE 80
CMD ["apachectl","-DFOREGROUND"]
