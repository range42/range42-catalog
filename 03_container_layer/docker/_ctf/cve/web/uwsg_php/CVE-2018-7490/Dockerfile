#
# ISSUE 95 
#

FROM debian:stretch

#
# delete old repo references 
#

RUN set -eux && \
    sed -i 's|deb.debian.org|archive.debian.org|g' /etc/apt/sources.list && \
    sed -i 's|security.debian.org|archive.debian.org|g' /etc/apt/sources.list && \
    sed -i '/stretch-updates/d' /etc/apt/sources.list && \
    apt-get update 

#
# setup packages 
#

RUN apt-get install --no-install-recommends -y \
        libphp7.0-embed \
        ca-certificates \
        wget \
        build-essential \
        python-dev \
        php7.0-dev \
        libonig-dev \
        libqdbm-dev \
        libz-dev \
        libxml2-dev

#
# get uwsgi archive 2.0.16
#

RUN wget -qO- https://github.com/unbit/uwsgi/archive/2.0.16.tar.gz \
    | tar xz -C /usr/src --strip-components=1

#
# install - step 1
#

RUN cd /usr/src && \
    make && \
    python uwsgiconfig.py --plugin plugins/php && \
    python uwsgiconfig.py --plugin plugins/http && \
    cp uwsgi php_plugin.so http_plugin.so /

#
# install - step 2 

#
RUN mkdir -p /var/www && \
    echo '<?=phpinfo()?>' > /var/www/index.php

#
# purge.
# 

RUN apt-get purge --autoremove -y build-essential ca-certificates wget && \
    rm -rf /usr/src /var/lib/apt/lists/*

#### #### #### #### #### #### #### #### #### #### #### #### #### #### 
#### #### #### #### #### #### #### #### #### #### #### #### #### #### 
#### #### #### #### #### #### #### #### #### #### #### #### #### #### 

COPY uwsgi.ini /etc/uwsgi.ini

WORKDIR /
EXPOSE 8181
CMD ["/uwsgi", "/etc/uwsgi.ini"]

